{{#if hasFunctionResult}}
{{#each functionResults}}
import os, json

_result = {
    "id": {{Id}},
    "result": {{Result}}
}

_result_path = f'/mnt/data/.io/function_results/{_result["id"]}.json'
os.makedirs(os.path.dirname(_result_path), exist_ok=True)

with open(_result_path, 'w') as f:
    f.write(json.dumps(_result))
{{/each}}
{{/if}}

import os, json, asyncio, traceback

async def _wd():
    _fc_path = '/mnt/data/.io/function_calls.txt'
    _res_file = '/mnt/data/.io/final_results.txt'
    _fc_pos = 0

    while True:
        _calls = []
        if os.path.exists(_fc_path):
            with open(_fc_path, 'r') as f:
                f.seek(_fc_pos)
                _calls = [json.loads(line) for line in f.readlines()]
                _fc_pos = f.tell()
                if _calls:
                    return json.dumps(_calls)

        if os.path.exists(_res_file):
            with open(_res_file, 'r') as f:
                _res = json.load(f)
            os.remove(_res_file)
            return json.dumps({'stdout': _res['stdout'], 'stderr': _res['stderr'], 'result': json.dumps(_res['result'])})
        await asyncio.sleep(0.01)

await _wd()
